name: Stage - Build & Deploy

on:
  pull_request:
    types:
      - closed
    branches:
      - stage
    paths-ignore:
      - '.gitignore'
      - 'README.md'

jobs:
  docker-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Build an image
        uses: ./.github/actions/basic-app-build
        with:
          docker_username: ${{ vars.DOCKERHUB_USERNAME }}
          docker_password: ${{ secrets.DOCKERHUB_TOKEN }}
          image_names: |
            ${{ vars.DOCKERHUB_USERNAME }}/jb-basic-app:${{ github.base_ref }}-${{ github.sha }}
            ${{ vars.DOCKERHUB_USERNAME }}/jb-basic-app:${{ github.base_ref }}-latest

      - name: Notify FAIL in Telegram
        if: failure()
        uses: ./.github/actions/telegram-notifier
        with:
          telegram_bot_token: '${{ secrets.TELEGRAM_BOT_TOKEN }}'
          telegram_chat_id: '${{ secrets.TELEGRAM_CHAT_ID }}'
          message_content: |
            ERROR
            An error occured while building the docker image

            More details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  deploy:
    runs-on: ubuntu-latest
    needs: docker-build
    environment:
      name: stage
      url: https://${{ github.base_ref }}.${{ vars.BASE_DOMAIN_NAME }}
    steps:
      - uses: actions/checkout@v5
      - name: Deploy a Helm-chart
        uses: ./.github/actions/basic-app-deploy
        with:
          kubeconfig: ${{ secrets.KUBECONFIG }}
          domain_name: ${{ github.base_ref }}.${{ vars.BASE_DOMAIN_NAME }}
          values_path: manifests-helm/values/stage.yaml
          namespace: ${{ github.base_ref }}
          release_name: ${{ github.base_ref }}
          image_tag: ${{ github.base_ref }}-${{ github.sha }}

      - name: Notify SUCCESS in Telegram
        if: success()
        uses: ./.github/actions/telegram-notifier
        with:
          telegram_bot_token: '${{ secrets.TELEGRAM_BOT_TOKEN }}'
          telegram_chat_id: '${{ secrets.TELEGRAM_CHAT_ID }}'
          message_content: |
            UPDATE
            Env: <code>${{ github.base_ref }}</code> 

            Link: https://${{ github.base_ref }}.${{ vars.BASE_DOMAIN_NAME }}

      - name: Notify FAIL in Telegram
        if: failure()
        uses: ./.github/actions/telegram-notifier
        with:
          telegram_bot_token: '${{ secrets.TELEGRAM_BOT_TOKEN }}'
          telegram_chat_id: '${{ secrets.TELEGRAM_CHAT_ID }}'
          message_content: |
            ERROR
            An error occured while deploying a <code>${{ github.base_ref }}</code>

            More details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
  
  run_vulnerability_tests:
    needs: docker-build
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ vars.DOCKERHUB_USERNAME }}/jb-basic-app:${{ github.base_ref }}-${{ github.sha }}
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'


  run_smoke_tests:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Wait while SSL certificate is issued
        run: |
          echo "Waiting for a trusted SSL certificate for ${{ github.base_ref }}.${{ vars.BASE_DOMAIN_NAME }} ..."

          for i in {1..30}; do
            if curl -sI "https://${{ github.base_ref }}.${{ vars.BASE_DOMAIN_NAME }}"  >/dev/null 2>&1; then
              echo "✅ Trusted SSL certificate is available for the domain"
              exit 0
            else
              sleep 10
            fi
          done

          echo "❌ Timeout: Trusted SSL certificate did not appear within 5 minutes."
          exit 1

      - name: Really strong test
        run: |
          curl --fail https://${{ github.base_ref }}.${{ vars.BASE_DOMAIN_NAME }}/healthCheck 

  promote_to_prod:
    needs:
      - run_vulnerability_tests
      - run_smoke_tests
    uses: ./.github/workflows/prod-deploy.yml
    with:
      image_tag: ${{ github.base_ref }}-${{ github.sha }}
